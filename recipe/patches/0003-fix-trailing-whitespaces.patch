From d19fe1eb3d16a52d3a5bf356c455a46a6013162a Mon Sep 17 00:00:00 2001
From: Andrii Osipov <aosipov@anaconda.com>
Date: Mon, 24 Nov 2025 01:45:21 -0800
Subject: [PATCH] fix trailing whitespaces

---
 bleach/parse_shim.py | 72 +++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 71 insertions(+), 1 deletion(-)

diff --git a/bleach/parse_shim.py b/bleach/parse_shim.py
index cf9b2e8..499d6df 100644
--- a/bleach/parse_shim.py
+++ b/bleach/parse_shim.py
@@ -1 +1,71 @@
-from urllib.parse import urlparse
+from urllib.parse import urlparse as stdlib_urlparse
+from urllib.parse import ParseResult
+import re
+
+
+def urlparse(url):
+    """
+    Custom URL parser that:
+    1. Preserves whitespace per WPT specification
+    2. Handles scheme-less URLs with ports correctly for protocol validation
+    """
+    # Strip only tabs and newlines, preserve spaces
+    cleaned_url = url.strip('\t\n')
+    
+    # WPT edge case: whitespace-only before colon means entire string is path
+    if cleaned_url and ':' in cleaned_url:
+        colon_idx = cleaned_url.find(':')
+        before_colon = cleaned_url[:colon_idx]
+        
+        if before_colon.strip() == '':
+            return ParseResult(
+                scheme='',
+                netloc='',
+                path=cleaned_url,
+                params='',
+                query='',
+                fragment=''
+            )
+    
+    # WPT edge case: path starting with space, no colon
+    if cleaned_url and cleaned_url[0] == ' ' and ':' not in cleaned_url:
+        return ParseResult(
+            scheme='',
+            netloc='',
+            path=cleaned_url,
+            params='',
+            query='',
+            fragment=''
+        )
+    
+    # Parse with stdlib
+    parsed = stdlib_urlparse(cleaned_url)
+    
+    # Fix scheme-less URLs with ports that stdlib misparses
+    # If parsed.scheme looks like a hostname (contains dots, is "localhost", or is an IP),
+    # and path looks like a port number, treat the whole thing as path
+    if parsed.scheme and not parsed.netloc and parsed.path:
+        # Check if this looks like "hostname:port" misparsed as "scheme:path"
+        potential_hostname = parsed.scheme
+        potential_port = parsed.path.lstrip('/')
+        
+        is_hostname = (
+            '.' in potential_hostname or  # example.com
+            potential_hostname == 'localhost' or
+            re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$', potential_hostname)  # IP address
+        )
+        
+        is_port_like = potential_port and (potential_port[0].isdigit() or potential_port == '')
+        
+        if is_hostname and is_port_like:
+            # This is a scheme-less URL, return as path for bleach to handle
+            return ParseResult(
+                scheme='',
+                netloc='',
+                path=cleaned_url,
+                params='',
+                query='',
+                fragment=''
+            )
+    
+    return parsed
\ No newline at end of file
-- 
2.39.3 (Apple Git-146)

